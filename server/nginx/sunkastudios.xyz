# global limit definition
limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=50r/s;

server {
	listen 80;
	server_name sunkastudios.xyz www.sunkastudios.xyz *.sunkastudios.xyz;
	return 301 https://$host$request_uri;
}
server {
	# use HTTPS
	listen 443 ssl;
	server_name sunkastudios.xyz www.sunkastudios.xyz *.sunkastudios.xyz;
	root /home/ubuntu/SunkaStudiosWebServer/server/public;
	# block php requests
	location ~* \.php$ {
		access_log off;
		log_not_found off;
		return 404;
	}
	# block wordpress requests
	location ~* /(wp-admin|wp-login|xmlrp|wp-content|wp-includes|wp-cron|wp-config)\.php {
		access_log off;
		log_not_found off;
		return 404;
	}
	# block known user_agent
	if ($http_user_agent ~* (curl|wget|python-requests|nikto|sqlmap|fimap|nmap|masscan|dirbuster|wpscan|acunetix|nessus|libwww|HTTrack|scrapy|bot|crawler|spider)) {
		return 403;
	}
	# block null hosts
	if ($host = "") {
		return 444;
	}

	# serve via nodejs
	location / {
		limit_req zone=req_limit_per_ip burst=200 nodelay;
		try_files $uri @node;
	}
	location @node {
		proxy_pass http://localhost:8080;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection 'Upgrade';
		proxy_set_header Host $host;
		proxy_cache_bypass $http_upgrade;
	}
	error_page 404 /404.html;

	# SSL config - do not touch!
	ssl_certificate /etc/letsencrypt/live/sunkastudios.xyz-0001/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/sunkastudios.xyz-0001/privkey.pem;
	include /etc/letsencrypt/options-ssl-nginx.conf;
	ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}
